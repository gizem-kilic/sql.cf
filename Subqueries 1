-- -- SQL Query using subqueries to find the average amount paid by the top 5 customers
-- Tables used: customer (B), address (C), city (D), country (E)

SELECT AVG(total_amount_paid) AS average  -- Calculate the average amount paid
FROM (
    SELECT 
        B.customer_id,                     -- Customer ID
        B.first_name,                      -- Customer's first name
        B.last_name,                       -- Customer's last name
        E.country,                         -- Customer's country
        D.city,                            -- Customer's city
        SUM(A.amount) AS total_amount_paid -- Total amount paid by the customer
    FROM 
        payment A                          -- Payment table
    INNER JOIN 
        customer B ON A.customer_id = B.customer_id -- Join with customer table
    INNER JOIN 
        address C ON B.address_id = C.address_id    -- Join with address table
    INNER JOIN 
        city D ON C.city_id = D.city_id              -- Join with city table
    INNER JOIN 
        country E ON D.country_id = E.country_id     -- Join with country table
    WHERE 
        D.city IN ('Atlixco', 'Aurora', 'Xintai', 'Adoni', 
                   'Dhule', 'Kurashiki', 'Pingxiang', 'Sivas', 
                   'Celaya', 'So Leopoldo')  -- Filter cities
    GROUP BY 
        B.customer_id, B.first_name, B.last_name, E.country, D.city  -- Group by customer details
    ORDER BY 
        total_amount_paid DESC                    -- Order by total amount paid in descending order
    LIMIT 5                                       -- Limit to the top 5 customers
) AS top_customers;                                -- Alias for the derived table
